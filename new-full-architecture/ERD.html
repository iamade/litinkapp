<!DOCTYPE html>
<html>
<head>
<title>ERD.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="entity-relationship-diagram-erd---litinkai-platform">Entity Relationship Diagram (ERD) - LitinkAI Platform</h1>
<p>This document provides comprehensive Entity Relationship Diagrams for the LitinkAI platform database schema using Supabase PostgreSQL with pgvector extension.</p>
<hr>
<h2 id="table-of-contents">Table of Contents</h2>
<ol>
<li><a href="#complete-database-schema">Complete Database Schema</a></li>
<li><a href="#core-domain-models">Core Domain Models</a></li>
<li><a href="#plot--character-models">Plot &amp; Character Models</a></li>
<li><a href="#media-generation-models">Media Generation Models</a></li>
<li><a href="#subscription--usage-models">Subscription &amp; Usage Models</a></li>
<li><a href="#gamification-models">Gamification Models</a></li>
<li><a href="#table-definitions">Table Definitions</a></li>
<li><a href="#indexes--constraints">Indexes &amp; Constraints</a></li>
</ol>
<hr>
<h2 id="complete-database-schema">Complete Database Schema</h2>
<h3 id="overall-system-erd">Overall System ERD</h3>
<pre><code class="language-mermaid"><div class="mermaid">erDiagram
    %% Authentication & Users
    users ||--o{ profiles : has
    profiles ||--o{ user_roles : has
    profiles ||--o{ books : creates
    profiles ||--o{ user_subscriptions : has
    profiles ||--o{ usage_logs : generates
    profiles ||--o{ badges : earns
    profiles ||--o{ nfts : owns
    
    %% Content Hierarchy
    books ||--o{ chapters : contains
    chapters ||--o{ scripts : has
    scripts ||--o{ scene_descriptions : contains
    scripts ||--o{ image_generations : generates
    scripts ||--o{ audio_generations : generates
    scripts ||--o{ video_generations : generates
    
    %% Plot System
    books ||--o{ plot_overviews : has
    plot_overviews ||--o{ characters : contains
    characters ||--o{ character_archetypes : uses
    scripts ||--o{ chapter_scripts : enhances
    
    %% Media Pipeline
    video_generations ||--o{ scene_videos : produces
    video_generations ||--o{ merge_jobs : requires
    merge_jobs ||--o{ merge_assets : uses
    
    %% Subscriptions
    user_subscriptions ||--o{ subscription_history : tracks
    user_subscriptions ||--o{ usage_logs : monitors
    usage_logs ||--o{ cost_aggregations : aggregates
    
    users {
        uuid id PK
        string email UK
        string encrypted_password
        timestamp email_confirmed_at
        timestamp last_sign_in_at
        jsonb raw_app_meta_data
        jsonb raw_user_meta_data
        timestamp created_at
        timestamp updated_at
    }
    
    profiles {
        uuid id PK,FK
        string email UK
        string display_name
        string avatar_url
        jsonb roles
        string user_mode
        boolean onboarding_complete
        timestamp created_at
        timestamp updated_at
    }
    
    books {
        uuid id PK
        uuid user_id FK
        string title
        string description
        string book_type
        string structure_type
        string status
        string file_url
        string cover_url
        integer total_chapters
        timestamp created_at
        timestamp updated_at
    }
    
    chapters {
        uuid id PK
        uuid book_id FK
        integer chapter_number
        string title
        text content
        text summary
        integer duration
        jsonb ai_content
        timestamp created_at
        timestamp updated_at
    }
</div></code></pre>
<hr>
<h2 id="core-domain-models">Core Domain Models</h2>
<h3 id="user--authentication-schema">User &amp; Authentication Schema</h3>
<pre><code class="language-mermaid"><div class="mermaid">erDiagram
    users ||--|| profiles : "has profile"
    profiles ||--o{ user_roles : "has many roles"
    profiles ||--o{ email_verifications : "tracks verification"
    
    users {
        uuid id PK "Supabase auth.users"
        string email UK "User email"
        string encrypted_password "Hashed password"
        timestamp email_confirmed_at "Email verification time"
        timestamp last_sign_in_at "Last login"
        jsonb raw_app_meta_data "App metadata"
        jsonb raw_user_meta_data "User metadata"
        timestamp created_at
        timestamp updated_at
    }
    
    profiles {
        uuid id PK "FK to users"
        string email UK "Synced from auth.users"
        string display_name "User's display name"
        string avatar_url "Profile picture URL"
        jsonb roles "Array of role strings"
        string user_mode "learning|creator|entertainment"
        boolean onboarding_complete "Has completed onboarding"
        timestamp created_at
        timestamp updated_at
    }
    
    user_roles {
        uuid id PK
        uuid user_id FK "FK to profiles"
        string role_name "user|creator|superadmin|author"
        timestamp granted_at
        uuid granted_by FK "Admin who granted role"
    }
    
    email_verifications {
        uuid id PK
        uuid user_id FK
        string token UK "Verification token"
        timestamp expires_at "Token expiration"
        boolean verified "Verification status"
        timestamp verified_at
        timestamp created_at
    }
</div></code></pre>
<h3 id="content-management-schema">Content Management Schema</h3>
<pre><code class="language-mermaid"><div class="mermaid">erDiagram
    books ||--o{ chapters : "contains"
    books ||--o{ book_structure : "has structure"
    chapters ||--o{ scripts : "has scripts"
    chapters ||--o{ chapter_embeddings : "has embeddings"
    scripts ||--o{ scene_descriptions : "contains scenes"
    
    books {
        uuid id PK
        uuid user_id FK "Book author"
        string title "Book title"
        text description "Book description"
        string book_type "learning|entertainment"
        string structure_type "linear|chapters|mixed"
        string status "draft|processing|ready|failed"
        string file_url "Original file location"
        string cover_url "Cover image URL"
        integer total_chapters "Number of chapters"
        jsonb metadata "Additional book metadata"
        timestamp processing_started_at
        timestamp processing_completed_at
        timestamp created_at
        timestamp updated_at
    }
    
    book_structure {
        uuid id PK
        uuid book_id FK UK
        jsonb structure_data "Parsed structure"
        string extraction_method "ai|manual|toc"
        timestamp confirmed_at "User confirmation"
        timestamp created_at
    }
    
    chapters {
        uuid id PK
        uuid book_id FK
        integer chapter_number "Sequential number"
        string title "Chapter title"
        text content "Chapter content"
        text summary "AI-generated summary"
        integer duration "Estimated reading time (minutes)"
        jsonb ai_content "Quiz, objectives, etc."
        timestamp created_at
        timestamp updated_at
    }
    
    chapter_embeddings {
        uuid id PK
        uuid chapter_id FK UK
        vector embedding "pgvector embedding"
        string embedding_model "Model used"
        integer dimension "Vector dimension"
        timestamp created_at
    }
    
    scripts {
        uuid id PK
        uuid chapter_id FK
        uuid user_id FK
        string script_style "cinematic|narration|educational"
        text script "Generated script"
        text character_details "Character info JSON"
        integer scene_count "Number of scenes"
        string story_type "From plot if available"
        uuid linked_script_id FK "Link to plot-enhanced script"
        string status "draft|active|archived"
        integer version "Version number"
        timestamp created_at
        timestamp updated_at
    }
    
    scene_descriptions {
        uuid id PK
        uuid script_id FK
        integer scene_number "Sequential number"
        string location "Scene location"
        string time_of_day "morning|afternoon|night"
        jsonb characters "Characters in scene"
        text key_actions "Main actions"
        text visual_description "Visual details"
        text audio_requirements "Audio needs"
        timestamp created_at
    }
</div></code></pre>
<hr>
<h2 id="plot--character-models">Plot &amp; Character Models</h2>
<h3 id="plot-system-erd">Plot System ERD</h3>
<pre><code class="language-mermaid"><div class="mermaid">erDiagram
    books ||--o{ plot_overviews : "has plot"
    plot_overviews ||--o{ characters : "contains"
    characters }o--o{ character_archetypes : "assigned"
    scripts ||--o{ chapter_scripts : "enhanced by plot"
    plot_overviews ||--o{ chapter_scripts : "enhances"
    
    plot_overviews {
        uuid id PK
        uuid book_id FK UK
        uuid user_id FK
        text logline "One-sentence summary"
        jsonb themes "Array of themes"
        string story_type "hero_journey|three_act|etc"
        string genre "Genre classification"
        string tone "Tone/mood"
        string audience "Target audience"
        text setting "Story setting"
        string generation_method "openrouter|manual"
        string model_used "AI model used"
        decimal generation_cost "Cost in USD"
        string status "active|archived|deleted"
        integer version "Version number"
        timestamp created_at
        timestamp updated_at
    }
    
    characters {
        uuid id PK
        uuid plot_overview_id FK
        uuid book_id FK
        uuid user_id FK
        string name UK "Character name"
        string role "protagonist|antagonist|supporting|minor"
        text character_arc "Character development"
        text physical_description "Physical traits"
        text personality "Personality traits"
        jsonb archetypes "Array of archetype IDs"
        text want "External goal"
        text need "Internal need"
        text lie "Character's false belief"
        text ghost "Backstory wound"
        string image_url "Character image"
        text image_generation_prompt "Image prompt used"
        jsonb image_metadata "Image generation metadata"
        string generation_method "openrouter|manual"
        string model_used "AI model used"
        timestamp created_at
        timestamp updated_at
    }
    
    character_archetypes {
        uuid id PK
        string name UK "Archetype name"
        text description "Archetype description"
        string category "hero|mentor|shadow|etc"
        jsonb traits "Typical traits"
        jsonb typical_roles "Common roles"
        text example_characters "Examples from literature"
        boolean is_active "Active status"
        timestamp created_at
    }
    
    chapter_scripts {
        uuid id PK
        uuid chapter_id FK
        uuid plot_overview_id FK
        uuid script_id FK
        uuid user_id FK
        boolean plot_enhanced "Used plot context"
        boolean character_enhanced "Used character details"
        jsonb scenes "Scene breakdown"
        jsonb acts "Act structure"
        jsonb beats "Story beats"
        jsonb character_details "Character info used"
        jsonb character_arcs "Arc progression"
        string status "active|archived|deleted"
        integer version "Version number"
        jsonb generation_metadata "Generation details"
        timestamp created_at
        timestamp updated_at
    }
</div></code></pre>
<hr>
<h2 id="media-generation-models">Media Generation Models</h2>
<h3 id="image-generation-erd">Image Generation ERD</h3>
<pre><code class="language-mermaid"><div class="mermaid">erDiagram
    scripts ||--o{ image_generations : "generates"
    chapters ||--o{ image_generations : "related to"
    image_generations ||--o{ image_generation_retries : "has retries"
    
    image_generations {
        uuid id PK
        uuid chapter_id FK
        uuid script_id FK
        uuid user_id FK
        string image_type "character|scene"
        string character_name "If character image"
        integer scene_number "If scene image"
        text prompt "Generation prompt"
        string status "pending|in_progress|completed|failed"
        string image_url "Generated image URL"
        string model_used "AI model"
        decimal cost_usd "Generation cost"
        jsonb metadata "Additional metadata"
        text error_message "Error if failed"
        integer retry_count "Number of retries"
        timestamp started_at
        timestamp completed_at
        timestamp created_at
        timestamp updated_at
    }
    
    image_generation_retries {
        uuid id PK
        uuid image_generation_id FK
        integer attempt_number "Retry attempt"
        string model_used "Model for this attempt"
        string status "Status of this attempt"
        text error_message "Error if any"
        decimal cost_usd "Cost of this attempt"
        timestamp attempted_at
    }
</div></code></pre>
<h3 id="audio-generation-erd">Audio Generation ERD</h3>
<pre><code class="language-mermaid"><div class="mermaid">erDiagram
    chapters ||--o{ audio_generations : "generates"
    scripts ||--o{ audio_generations : "uses"
    scene_descriptions ||--o{ audio_generations : "for scene"
    
    audio_generations {
        uuid id PK
        uuid chapter_id FK
        uuid script_id FK
        uuid scene_description_id FK
        uuid user_id FK
        string audio_type "narration|dialogue|sound_effect|music"
        integer scene_number "Scene reference"
        text text_content "Text to synthesize"
        string voice_id "Voice model ID"
        jsonb voice_settings "ElevenLabs settings"
        string status "pending|in_progress|completed|failed"
        string audio_url "Generated audio URL"
        integer duration_ms "Audio duration"
        string model_used "elevenlabs|modelslab"
        decimal cost_usd "Generation cost"
        jsonb metadata "Additional metadata"
        text error_message "Error if failed"
        timestamp started_at
        timestamp completed_at
        timestamp created_at
        timestamp updated_at
    }
</div></code></pre>
<h3 id="video-generation-erd">Video Generation ERD</h3>
<pre><code class="language-mermaid"><div class="mermaid">erDiagram
    scripts ||--o{ video_generations : "generates from"
    video_generations ||--o{ scene_videos : "produces"
    video_generations ||--o{ merge_jobs : "requires merge"
    scene_videos ||--o{ lipsync_jobs : "lip syncs"
    
    video_generations {
        uuid id PK
        uuid chapter_id FK
        uuid script_id FK
        uuid user_id FK
        string status "pending|script|images|audio|video|lipsync|merge|completed|failed"
        integer progress_percentage "0-100"
        string last_completed_step "Last successful step"
        string current_step "Current processing step"
        text error_message "Error if failed"
        string video_url "Final merged video URL"
        string quality_tier "free|basic|standard|premium"
        decimal total_cost_usd "Total generation cost"
        jsonb pipeline_metadata "Step-by-step metadata"
        integer total_scenes "Number of scenes"
        integer completed_scenes "Scenes completed"
        timestamp started_at
        timestamp completed_at
        timestamp created_at
        timestamp updated_at
    }
    
    scene_videos {
        uuid id PK
        uuid video_generation_id FK
        integer scene_number "Scene sequence"
        string scene_video_url "Video URL before lipsync"
        string lipsynced_video_url "Video URL after lipsync"
        integer duration_ms "Video duration"
        string status "pending|generating|completed|failed"
        string model_used "modelslab-veo2|veo3"
        decimal cost_usd "Scene generation cost"
        jsonb metadata "Generation metadata"
        timestamp created_at
        timestamp updated_at
    }
    
    lipsync_jobs {
        uuid id PK
        uuid scene_video_id FK UK
        uuid video_generation_id FK
        uuid audio_generation_id FK
        string status "pending|processing|completed|failed"
        string input_video_url "Original video"
        string input_audio_url "Audio for sync"
        string output_video_url "Lip-synced result"
        string model_used "Lip sync model"
        decimal cost_usd "Processing cost"
        text error_message "Error if failed"
        timestamp started_at
        timestamp completed_at
        timestamp created_at
    }
    
    merge_jobs {
        uuid id PK
        uuid video_generation_id FK UK
        uuid user_id FK
        string merge_type "auto|manual"
        string status "pending|processing|completed|failed"
        jsonb input_videos "Array of video URLs"
        jsonb ffmpeg_params "FFmpeg parameters"
        string output_video_url "Merged video URL"
        integer output_duration_ms "Final duration"
        integer output_size_bytes "File size"
        text error_message "Error if failed"
        timestamp started_at
        timestamp completed_at
        timestamp created_at
        timestamp updated_at
    }
    
    merge_assets {
        uuid id PK
        uuid merge_job_id FK
        string asset_type "video|audio|image"
        string asset_url "Asset location"
        integer sequence_order "Order in merge"
        jsonb transform_params "Transformations applied"
        timestamp created_at
    }
</div></code></pre>
<hr>
<h2 id="subscription--usage-models">Subscription &amp; Usage Models</h2>
<h3 id="subscription-system-erd">Subscription System ERD</h3>
<pre><code class="language-mermaid"><div class="mermaid">erDiagram
    profiles ||--o{ user_subscriptions : "has"
    user_subscriptions ||--o{ subscription_history : "tracks changes"
    user_subscriptions ||--o{ usage_logs : "monitors"
    usage_logs ||--o{ cost_aggregations : "aggregates to"
    
    user_subscriptions {
        uuid id PK
        uuid user_id FK UK
        string tier "free|basic|standard|premium|professional|enterprise"
        string status "active|canceled|past_due|trialing"
        string stripe_subscription_id UK
        string stripe_customer_id
        timestamp current_period_start
        timestamp current_period_end
        integer video_count_limit "Videos per month"
        integer video_count_used "Videos used this period"
        boolean cancel_at_period_end
        timestamp trial_end
        timestamp created_at
        timestamp updated_at
    }
    
    subscription_history {
        uuid id PK
        uuid user_id FK
        uuid subscription_id FK
        string from_tier "Previous tier"
        string to_tier "New tier"
        string change_reason "upgrade|downgrade|cancel|renewal"
        timestamp effective_date "When change occurred"
        timestamp created_at
    }
    
    usage_logs {
        uuid id PK
        uuid user_id FK
        uuid subscription_id FK
        string resource_type "script|image|audio|video|plot"
        string model_used "AI model identifier"
        integer input_tokens "Input token count"
        integer output_tokens "Output token count"
        float duration_seconds "Processing duration"
        decimal cost_usd "Cost in USD"
        string tier_at_time "User tier when generated"
        jsonb metadata "Additional context"
        timestamp created_at
    }
    
    cost_aggregations {
        uuid id PK
        uuid user_id FK
        date period_start "Aggregation start"
        date period_end "Aggregation end"
        decimal total_cost "Total cost in period"
        integer total_videos "Videos generated"
        jsonb breakdown "Cost by resource type"
        timestamp created_at
    }
    
    model_metrics {
        uuid id PK
        string model_name UK "Model identifier"
        integer request_count "Total requests"
        integer success_count "Successful requests"
        integer failure_count "Failed requests"
        float avg_latency_ms "Average latency"
        decimal avg_cost_usd "Average cost"
        date date UK "Metrics date"
    }
</div></code></pre>
<hr>
<h2 id="gamification-models">Gamification Models</h2>
<h3 id="badges--nfts-erd">Badges &amp; NFTs ERD</h3>
<pre><code class="language-mermaid"><div class="mermaid">erDiagram
    profiles ||--o{ user_badges : "earns"
    badges ||--o{ user_badges : "awarded to"
    profiles ||--o{ nfts : "owns"
    user_badges ||--o{ nfts : "minted as"
    
    badges {
        uuid id PK
        string name UK "Badge name"
        text description "Badge description"
        string category "achievement|milestone|skill"
        string rarity "common|rare|epic|legendary"
        string icon_url "Badge icon"
        jsonb criteria "Earning criteria"
        integer xp_reward "XP awarded"
        boolean is_active "Active status"
        timestamp created_at
        timestamp updated_at
    }
    
    user_badges {
        uuid id PK
        uuid user_id FK
        uuid badge_id FK
        timestamp earned_at "When earned"
        jsonb earning_context "How earned"
        boolean displayed "Show on profile"
        timestamp created_at
    }
    
    nfts {
        uuid id PK
        uuid user_id FK
        uuid badge_id FK
        string asset_id UK "Blockchain asset ID"
        string blockchain "algorand|polygon"
        string transaction_id "Blockchain tx ID"
        string metadata_uri "IPFS metadata"
        string image_uri "IPFS image"
        jsonb attributes "NFT attributes"
        string status "pending|minted|failed"
        timestamp minted_at
        timestamp created_at
    }
    
    user_progress {
        uuid id PK
        uuid user_id FK UK
        integer total_xp "Total experience points"
        integer level "Current level"
        integer videos_created "Total videos"
        integer books_uploaded "Total books"
        integer quizzes_completed "Total quizzes"
        decimal total_spent_usd "Total spending"
        jsonb achievements "Achievement flags"
        timestamp created_at
        timestamp updated_at
    }
</div></code></pre>
<hr>
<h2 id="table-definitions">Table Definitions</h2>
<h3 id="core-tables-detail">Core Tables Detail</h3>
<h4 id="users-supabase-auth">users (Supabase Auth)</h4>
<pre class="hljs"><code><div><span class="hljs-comment">-- Managed by Supabase Auth</span>
<span class="hljs-comment">-- Located in auth.users schema</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> auth.users (
    <span class="hljs-keyword">id</span> <span class="hljs-keyword">UUID</span> PRIMARY <span class="hljs-keyword">KEY</span> <span class="hljs-keyword">DEFAULT</span> gen_random_uuid(),
    email <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    encrypted_password <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>),
    email_confirmed_at TIMESTAMPTZ,
    last_sign_in_at TIMESTAMPTZ,
    raw_app_meta_data JSONB,
    raw_user_meta_data JSONB,
    created_at TIMESTAMPTZ <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NOW</span>(),
    updated_at TIMESTAMPTZ <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NOW</span>()
);
</div></code></pre>
<h4 id="profiles">profiles</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">profiles</span> (
    <span class="hljs-keyword">id</span> <span class="hljs-keyword">UUID</span> PRIMARY <span class="hljs-keyword">KEY</span> <span class="hljs-keyword">REFERENCES</span> auth.users(<span class="hljs-keyword">id</span>) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">CASCADE</span>,
    email <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    display_name <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">255</span>),
    avatar_url <span class="hljs-built_in">TEXT</span>,
    <span class="hljs-keyword">roles</span> JSONB <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'["user"]'</span>::jsonb,
    user_mode <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'learning'</span>,
    onboarding_complete <span class="hljs-built_in">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">false</span>,
    created_at TIMESTAMPTZ <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NOW</span>(),
    updated_at TIMESTAMPTZ <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NOW</span>(),
    
    <span class="hljs-keyword">CONSTRAINT</span> valid_user_mode <span class="hljs-keyword">CHECK</span> (user_mode <span class="hljs-keyword">IN</span> (<span class="hljs-string">'learning'</span>, <span class="hljs-string">'creator'</span>, <span class="hljs-string">'entertainment'</span>))
);

<span class="hljs-comment">-- Row Level Security</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">profiles</span> <span class="hljs-keyword">ENABLE</span> <span class="hljs-keyword">ROW</span> <span class="hljs-keyword">LEVEL</span> <span class="hljs-keyword">SECURITY</span>;

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">POLICY</span> <span class="hljs-string">"Users can view own profile"</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">profiles</span>
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">USING</span> (auth.uid() = <span class="hljs-keyword">id</span>);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">POLICY</span> <span class="hljs-string">"Users can update own profile"</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">profiles</span>
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">USING</span> (auth.uid() = <span class="hljs-keyword">id</span>);
</div></code></pre>
<h4 id="books">books</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> books (
    <span class="hljs-keyword">id</span> <span class="hljs-keyword">UUID</span> PRIMARY <span class="hljs-keyword">KEY</span> <span class="hljs-keyword">DEFAULT</span> gen_random_uuid(),
    user_id <span class="hljs-keyword">UUID</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">REFERENCES</span> auth.users(<span class="hljs-keyword">id</span>) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">CASCADE</span>,
    title <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">500</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    description <span class="hljs-built_in">TEXT</span>,
    book_type <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    structure_type <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'linear'</span>,
    <span class="hljs-keyword">status</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'draft'</span>,
    file_url <span class="hljs-built_in">TEXT</span>,
    cover_url <span class="hljs-built_in">TEXT</span>,
    total_chapters <span class="hljs-built_in">INTEGER</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
    metadata JSONB <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'{}'</span>::jsonb,
    processing_started_at TIMESTAMPTZ,
    processing_completed_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NOW</span>(),
    updated_at TIMESTAMPTZ <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NOW</span>(),
    
    <span class="hljs-keyword">CONSTRAINT</span> valid_book_type <span class="hljs-keyword">CHECK</span> (book_type <span class="hljs-keyword">IN</span> (<span class="hljs-string">'learning'</span>, <span class="hljs-string">'entertainment'</span>)),
    <span class="hljs-keyword">CONSTRAINT</span> valid_status <span class="hljs-keyword">CHECK</span> (<span class="hljs-keyword">status</span> <span class="hljs-keyword">IN</span> (<span class="hljs-string">'draft'</span>, <span class="hljs-string">'processing'</span>, <span class="hljs-string">'ready'</span>, <span class="hljs-string">'failed'</span>))
);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_books_user_id <span class="hljs-keyword">ON</span> books(user_id);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_books_status <span class="hljs-keyword">ON</span> books(<span class="hljs-keyword">status</span>);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_books_created_at <span class="hljs-keyword">ON</span> books(created_at <span class="hljs-keyword">DESC</span>);
</div></code></pre>
<h4 id="chapters">chapters</h4>
<pre class="hljs"><code><div><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> chapters (
    <span class="hljs-keyword">id</span> <span class="hljs-keyword">UUID</span> PRIMARY <span class="hljs-keyword">KEY</span> <span class="hljs-keyword">DEFAULT</span> gen_random_uuid(),
    book_id <span class="hljs-keyword">UUID</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">REFERENCES</span> books(<span class="hljs-keyword">id</span>) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">CASCADE</span>,
    chapter_number <span class="hljs-built_in">INTEGER</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    title <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">500</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-keyword">content</span> <span class="hljs-built_in">TEXT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    summary <span class="hljs-built_in">TEXT</span>,
    <span class="hljs-keyword">duration</span> <span class="hljs-built_in">INTEGER</span>, <span class="hljs-comment">-- estimated reading time in minutes</span>
    ai_content JSONB <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'{}'</span>::jsonb,
    created_at TIMESTAMPTZ <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NOW</span>(),
    updated_at TIMESTAMPTZ <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NOW</span>(),
    
    <span class="hljs-keyword">CONSTRAINT</span> unique_chapter_number <span class="hljs-keyword">UNIQUE</span>(book_id, chapter_number)
);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_chapters_book_id <span class="hljs-keyword">ON</span> chapters(book_id);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_chapters_number <span class="hljs-keyword">ON</span> chapters(book_id, chapter_number);
</div></code></pre>
<hr>
<h2 id="indexes--constraints">Indexes &amp; Constraints</h2>
<h3 id="performance-indexes">Performance Indexes</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- User &amp; Profile Indexes</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_profiles_email <span class="hljs-keyword">ON</span> <span class="hljs-keyword">profiles</span>(email);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_profiles_roles <span class="hljs-keyword">ON</span> <span class="hljs-keyword">profiles</span> <span class="hljs-keyword">USING</span> GIN(<span class="hljs-keyword">roles</span>);

<span class="hljs-comment">-- Book &amp; Chapter Indexes</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_books_user_type <span class="hljs-keyword">ON</span> books(user_id, book_type);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_chapters_book_number <span class="hljs-keyword">ON</span> chapters(book_id, chapter_number);

<span class="hljs-comment">-- Script Indexes</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_scripts_chapter_user <span class="hljs-keyword">ON</span> scripts(chapter_id, user_id);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_scripts_status <span class="hljs-keyword">ON</span> scripts(<span class="hljs-keyword">status</span>) <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> = <span class="hljs-string">'active'</span>;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_scene_descriptions_script <span class="hljs-keyword">ON</span> scene_descriptions(script_id, scene_number);

<span class="hljs-comment">-- Plot Indexes</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_plot_overviews_book_user <span class="hljs-keyword">ON</span> plot_overviews(book_id, user_id);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_characters_plot <span class="hljs-keyword">ON</span> <span class="hljs-keyword">characters</span>(plot_overview_id);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_characters_archetypes <span class="hljs-keyword">ON</span> <span class="hljs-keyword">characters</span> <span class="hljs-keyword">USING</span> GIN(archetypes);

<span class="hljs-comment">-- Media Generation Indexes</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_image_gens_chapter <span class="hljs-keyword">ON</span> image_generations(chapter_id, image_type);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_image_gens_status <span class="hljs-keyword">ON</span> image_generations(<span class="hljs-keyword">status</span>) <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> <span class="hljs-keyword">IN</span> (<span class="hljs-string">'pending'</span>, <span class="hljs-string">'in_progress'</span>);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_audio_gens_chapter <span class="hljs-keyword">ON</span> audio_generations(chapter_id, audio_type);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_video_gens_status <span class="hljs-keyword">ON</span> video_generations(<span class="hljs-keyword">status</span>) <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">status</span> != <span class="hljs-string">'completed'</span>;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_scene_videos_generation <span class="hljs-keyword">ON</span> scene_videos(video_generation_id, scene_number);

<span class="hljs-comment">-- Subscription Indexes</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_subscriptions_user <span class="hljs-keyword">ON</span> user_subscriptions(user_id);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_subscriptions_stripe <span class="hljs-keyword">ON</span> user_subscriptions(stripe_subscription_id);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_usage_logs_user_date <span class="hljs-keyword">ON</span> usage_logs(user_id, created_at <span class="hljs-keyword">DESC</span>);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_usage_logs_resource <span class="hljs-keyword">ON</span> usage_logs(resource_type, created_at <span class="hljs-keyword">DESC</span>);

<span class="hljs-comment">-- Vector Search Index (pgvector)</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> idx_chapter_embeddings_vector <span class="hljs-keyword">ON</span> chapter_embeddings 
    <span class="hljs-keyword">USING</span> ivfflat (embedding vector_cosine_ops)
    <span class="hljs-keyword">WITH</span> (lists = <span class="hljs-number">100</span>);
</div></code></pre>
<h3 id="foreign-key-constraints">Foreign Key Constraints</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Cascade deletes for user content</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> books <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">CONSTRAINT</span> fk_books_user 
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (user_id) <span class="hljs-keyword">REFERENCES</span> auth.users(<span class="hljs-keyword">id</span>) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">CASCADE</span>;

<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> chapters <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">CONSTRAINT</span> fk_chapters_book 
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (book_id) <span class="hljs-keyword">REFERENCES</span> books(<span class="hljs-keyword">id</span>) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">CASCADE</span>;

<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> scripts <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">CONSTRAINT</span> fk_scripts_chapter 
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (chapter_id) <span class="hljs-keyword">REFERENCES</span> chapters(<span class="hljs-keyword">id</span>) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">CASCADE</span>;

<span class="hljs-comment">-- Protect critical references</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> video_generations <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">CONSTRAINT</span> fk_video_gen_script 
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (script_id) <span class="hljs-keyword">REFERENCES</span> scripts(<span class="hljs-keyword">id</span>) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> RESTRICT;

<span class="hljs-comment">-- Nullify optional references</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> chapter_scripts <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">CONSTRAINT</span> fk_chapter_scripts_plot 
    <span class="hljs-keyword">FOREIGN</span> <span class="hljs-keyword">KEY</span> (plot_overview_id) <span class="hljs-keyword">REFERENCES</span> plot_overviews(<span class="hljs-keyword">id</span>) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">SET</span> <span class="hljs-literal">NULL</span>;
</div></code></pre>
<h3 id="check-constraints">Check Constraints</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Ensure valid enums</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> books <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">CONSTRAINT</span> check_book_type 
    <span class="hljs-keyword">CHECK</span> (book_type <span class="hljs-keyword">IN</span> (<span class="hljs-string">'learning'</span>, <span class="hljs-string">'entertainment'</span>));

<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> user_subscriptions <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">CONSTRAINT</span> check_subscription_tier 
    <span class="hljs-keyword">CHECK</span> (<span class="hljs-keyword">tier</span> <span class="hljs-keyword">IN</span> (<span class="hljs-string">'free'</span>, <span class="hljs-string">'basic'</span>, <span class="hljs-string">'standard'</span>, <span class="hljs-string">'premium'</span>, <span class="hljs-string">'professional'</span>, <span class="hljs-string">'enterprise'</span>));

<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> image_generations <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">CONSTRAINT</span> check_image_type 
    <span class="hljs-keyword">CHECK</span> (image_type <span class="hljs-keyword">IN</span> (<span class="hljs-string">'character'</span>, <span class="hljs-string">'scene'</span>));

<span class="hljs-comment">-- Ensure logical values</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> video_generations <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">CONSTRAINT</span> check_progress 
    <span class="hljs-keyword">CHECK</span> (progress_percentage &gt;= <span class="hljs-number">0</span> <span class="hljs-keyword">AND</span> progress_percentage &lt;= <span class="hljs-number">100</span>);

<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> chapters <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">CONSTRAINT</span> check_positive_number 
    <span class="hljs-keyword">CHECK</span> (chapter_number &gt; <span class="hljs-number">0</span>);
</div></code></pre>
<hr>
<h2 id="row-level-security-rls-policies">Row Level Security (RLS) Policies</h2>
<h3 id="user-content-protection">User Content Protection</h3>
<pre class="hljs"><code><div><span class="hljs-comment">-- Books: Users can only access their own books</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">POLICY</span> <span class="hljs-string">"Users manage own books"</span> <span class="hljs-keyword">ON</span> books
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">USING</span> (auth.uid() = user_id);

<span class="hljs-comment">-- Chapters: Access via book ownership</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">POLICY</span> <span class="hljs-string">"Users access own book chapters"</span> <span class="hljs-keyword">ON</span> chapters
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">USING</span> (
        <span class="hljs-keyword">EXISTS</span> (
            <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> books 
            <span class="hljs-keyword">WHERE</span> books.id = chapters.book_id 
            <span class="hljs-keyword">AND</span> books.user_id = auth.uid()
        )
    );

<span class="hljs-comment">-- Scripts: Users manage their own scripts</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">POLICY</span> <span class="hljs-string">"Users manage own scripts"</span> <span class="hljs-keyword">ON</span> scripts
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">USING</span> (auth.uid() = user_id);

<span class="hljs-comment">-- Plot &amp; Characters: Owner access only</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">POLICY</span> <span class="hljs-string">"Users manage own plots"</span> <span class="hljs-keyword">ON</span> plot_overviews
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">USING</span> (auth.uid() = user_id);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">POLICY</span> <span class="hljs-string">"Users manage own characters"</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">characters</span>
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">USING</span> (auth.uid() = user_id);

<span class="hljs-comment">-- Media Generations: Owner access via relationships</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">POLICY</span> <span class="hljs-string">"Users access own image generations"</span> <span class="hljs-keyword">ON</span> image_generations
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">USING</span> (auth.uid() = user_id);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">POLICY</span> <span class="hljs-string">"Users access own video generations"</span> <span class="hljs-keyword">ON</span> video_generations
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">USING</span> (auth.uid() = user_id);

<span class="hljs-comment">-- Subscriptions: User access only</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">POLICY</span> <span class="hljs-string">"Users view own subscription"</span> <span class="hljs-keyword">ON</span> user_subscriptions
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">USING</span> (auth.uid() = user_id);

<span class="hljs-comment">-- Public access for reference data</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">POLICY</span> <span class="hljs-string">"Anyone can view active archetypes"</span> <span class="hljs-keyword">ON</span> character_archetypes
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">USING</span> (is_active = <span class="hljs-literal">true</span>);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">POLICY</span> <span class="hljs-string">"Anyone can view active badges"</span> <span class="hljs-keyword">ON</span> badges
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">USING</span> (is_active = <span class="hljs-literal">true</span>);
</div></code></pre>
<hr>
<h2 id="database-statistics">Database Statistics</h2>
<h3 id="current-schema-size-estimates">Current Schema Size Estimates</h3>
<table>
<thead>
<tr>
<th>Domain</th>
<th>Tables</th>
<th>Est. Rows/User</th>
<th>Storage Impact</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Core</strong></td>
<td>5</td>
<td>50-100</td>
<td>Low</td>
</tr>
<tr>
<td><strong>Plot</strong></td>
<td>4</td>
<td>10-50</td>
<td>Low</td>
</tr>
<tr>
<td><strong>Media</strong></td>
<td>8</td>
<td>500-5000</td>
<td>High (URLs only)</td>
</tr>
<tr>
<td><strong>Subscriptions</strong></td>
<td>4</td>
<td>100-1000</td>
<td>Medium</td>
</tr>
<tr>
<td><strong>Gamification</strong></td>
<td>4</td>
<td>20-100</td>
<td>Low</td>
</tr>
<tr>
<td><strong>Total</strong></td>
<td><strong>25</strong></td>
<td><strong>680-6250</strong></td>
<td><strong>Medium</strong></td>
</tr>
</tbody>
</table>
<p><em>Note: Actual media files stored in Supabase Storage (S3), not in database</em></p>
<hr>
<h2 id="migration-scripts">Migration Scripts</h2>
<p>See individual migration files in <a href="../backend/supabase/migrations/"><code>backend/supabase/migrations/</code></a> and <a href="../supabase/migrations/"><code>supabase/migrations/</code></a>.</p>
<p>Key migrations:</p>
<ul>
<li><code>20251015_add_scene_fields_to_generations.sql</code></li>
<li><code>20251015_add_multi_role_system_and_ownership_tracking.sql</code></li>
<li><code>20251017_add_email_verification_system.sql</code></li>
</ul>
<hr>
<h2 id="references">References</h2>
<ul>
<li><a href="https://www.postgresql.org/docs/">PostgreSQL Documentation</a></li>
<li><a href="https://supabase.com/docs/guides/database">Supabase Database Guide</a></li>
<li><a href="https://github.com/pgvector/pgvector">pgvector Extension</a></li>
<li><a href="README.md">Main Architecture README</a></li>
</ul>
<hr>
<p><strong>Last Updated</strong>: 2025-11-06<br>
<strong>Version</strong>: 1.0<br>
<strong>Schema Version</strong>: 2.5 (based on migrations)</p>

</body>
</html>
