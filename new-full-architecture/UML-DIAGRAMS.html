<!DOCTYPE html>
<html>
<head>
<title>UML-DIAGRAMS.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="uml-diagrams---litinkai-platform">UML Diagrams - LitinkAI Platform</h1>
<p>This document provides comprehensive UML diagrams for the LitinkAI platform, including Class, Sequence, and Activity diagrams for key workflows and components.</p>
<hr>
<h2 id="table-of-contents">Table of Contents</h2>
<ol>
<li><a href="#class-diagrams">Class Diagrams</a></li>
<li><a href="#sequence-diagrams">Sequence Diagrams</a></li>
<li><a href="#activity-diagrams">Activity Diagrams</a></li>
<li><a href="#state-machine-diagrams">State Machine Diagrams</a></li>
</ol>
<hr>
<h2 id="class-diagrams">Class Diagrams</h2>
<h3 id="1-core-services-class-diagram">1. Core Services Class Diagram</h3>
<pre><code class="language-mermaid"><div class="mermaid">classDiagram
    class OpenRouterService {
        -AsyncOpenAI client
        -CostTracker cost_tracker
        -str api_key
        -str base_url
        +generate_script(content, user_tier, script_type, duration, plot_context) Dict
        +analyze_content(content, user_tier, analysis_type) Dict
        +get_available_models() Dict
        -_execute_generation(model, content, ...) Dict
        -_prepare_script_messages(content, script_type, ...) List
    }

    class AIService {
        -AsyncOpenAI openai_client
        -AsyncOpenAI deepseek_client
        -AsyncOpenAI client
        +generate_quiz(content, difficulty, provider) List~Dict~
        +generate_lesson(content, topic, provider) Dict
        +generate_chapters_from_content(content, book_type, provider) List~Dict~
        +generate_summary(content, provider) str
        +extract_keywords(content, provider) List~str~
        +generate_text_from_prompt(prompt, provider) str
        -_make_completion(messages, model, provider, **kwargs) Any
    }

    class RAGService {
        -supabase_client Client
        -embeddings_service EmbeddingsService
        +get_chapter_with_context(chapter_id, include_adjacent, use_vector_search) Dict
        +get_book_plot_context(book_id) Dict
        +create_chapter_embeddings(chapter_id) Dict
        +search_similar_chapters(query, book_id, limit) List~Dict~
        +enhance_script_with_book_context(script, chapter_id, plot_overview) Dict
        -_extract_character_frequencies(content) Dict
    }

    class PlotService {
        -supabase_client Client
        -OpenRouterService openrouter
        -SubscriptionManager subscription_manager
        -RAGService rag_service
        +generate_plot_overview(book_id, user_id, custom_instructions) Dict
        +save_plot_overview(book_id, user_id, plot_data) Dict
        +get_plot_overview(book_id, user_id) Dict
        +enhance_script_with_plot(chapter_id, script_id, user_id) Dict
        -_generate_characters_with_archetypes(plot_context, book_context, user_tier) List~Dict~
        -_store_plot_overview(book_id, user_id, plot_data, characters, metadata) Dict
    }

    class CharacterService {
        -supabase_client Client
        -OpenRouterService openrouter
        +analyze_character_archetypes(character_description, user_tier) Dict
        +generate_character_image(character_id, user_id, custom_prompt) str
        +get_character_by_id(character_id) Dict
        +update_character(character_id, character_data) Dict
        -_get_available_archetypes() List~Dict~
        -_build_character_image_prompt(character) str
    }

    class SubscriptionManager {
        -supabase_client Client
        -stripe Stripe
        +get_user_tier(user_id) ModelTier
        +check_usage_limits(user_id, resource_type) Dict
        +record_usage(user_id, resource_type, cost_usd, metadata) void
        +create_checkout_session(user_id, tier, success_url, cancel_url) Dict
        +handle_webhook(event_type, event_data) void
        -_update_subscription(user_id, subscription_data) void
    }

    class ModelFallbackManager {
        -circuit_breakers Dict
        -fallback_chains Dict
        +try_with_fallback(service_type, user_tier, generation_function, request_params, model_param_name) Dict
        +record_success(service_type, tier, model) void
        +record_failure(service_type, tier, model) void
        -_get_fallback_models(service_type, tier) List~str~
        -_should_trigger_circuit_breaker(model) bool
    }

    class CostTracker {
        -redis_client Redis
        -supabase_client Client
        +track(user_tier, model, input_tokens, output_tokens, cost) void
        +get_monthly_costs(user_id) Dict
        +get_cost_by_tier(tier, start_date, end_date) Dict
        -_check_cost_threshold(user_id, current_cost) void
    }

    OpenRouterService --> CostTracker : uses
    OpenRouterService --> ModelFallbackManager : uses
    PlotService --> OpenRouterService : uses
    PlotService --> RAGService : uses
    PlotService --> SubscriptionManager : uses
    CharacterService --> OpenRouterService : uses
    AIService ..> OpenRouterService : alternative
</div></code></pre>
<h3 id="2-celery-task-system-class-diagram">2. Celery Task System Class Diagram</h3>
<pre><code class="language-mermaid"><div class="mermaid">classDiagram
    class CeleryApp {
        -broker_url str
        -result_backend str
        -task_serializer str
        +config_from_object(config) void
        +autodiscover_tasks(packages) void
    }

    class ImageTask {
        <<celery_task>>
        +generate_character_image_task(character_name, description, user_id, ...) Dict
        +generate_scene_image_task(record_id, description, scene_number, user_id) Dict
        -_update_generation_status(record_id, status, image_url, error) void
        -_call_modelslab_api(prompt, aspect_ratio, model_id) Dict
    }

    class VideoTask {
        <<celery_task>>
        +generate_scene_video_task(video_gen_id, scene_number, image_url, audio_url) Dict
        +process_video_pipeline(video_gen_id) Dict
        -_generate_video_from_image(image_url, audio_url, duration) str
        -_update_scene_video(scene_video_id, status, video_url) void
    }

    class AudioTask {
        <<celery_task>>
        +generate_audio_task(audio_gen_id, text, voice_id, settings) Dict
        +generate_narration_task(chapter_id, script_id, scene_number) Dict
        -_call_elevenlabs_api(text, voice_id, settings) bytes
        -_upload_to_storage(audio_data, file_name) str
    }

    class MergeTask {
        <<celery_task>>
        +merge_videos_task(merge_job_id, video_urls, ffmpeg_params) Dict
        +merge_with_audio_task(video_url, audio_url, output_name) str
        -_execute_ffmpeg_command(input_files, output_file, params) bool
        -_validate_output(output_file) bool
    }

    class LipSyncTask {
        <<celery_task>>
        +lipsync_video_task(lipsync_job_id, video_url, audio_url) Dict
        -_process_lipsync(video_path, audio_path) str
        -_update_lipsync_status(job_id, status, output_url) void
    }

    class BlockchainTask {
        <<celery_task>>
        +mint_nft_badge_task(user_id, badge_id, metadata) Dict
        -_create_nft_metadata(badge_data) Dict
        -_upload_to_ipfs(metadata) str
        -_mint_on_algorand(user_address, metadata_uri) str
    }

    CeleryApp --> ImageTask : registers
    CeleryApp --> VideoTask : registers
    CeleryApp --> AudioTask : registers
    CeleryApp --> MergeTask : registers
    CeleryApp --> LipSyncTask : registers
    CeleryApp --> BlockchainTask : registers

    VideoTask ..> ImageTask : depends on
    VideoTask ..> AudioTask : depends on
    MergeTask ..> VideoTask : depends on
    LipSyncTask ..> VideoTask : depends on
</div></code></pre>
<h3 id="3-api-route-handlers-class-diagram">3. API Route Handlers Class Diagram</h3>
<pre><code class="language-mermaid"><div class="mermaid">classDiagram
    class FastAPIApp {
        +title str
        +version str
        +include_router(router, prefix) void
        +add_middleware(middleware_class) void
    }

    class AuthRouter {
        +register(request: RegisterRequest) UserSchema
        +login(request: LoginRequest) Token
        +verify_email(token: str) Dict
        +request_password_reset(email: str) Dict
        +refresh_token(refresh_token: str) Token
    }

    class BooksRouter {
        +upload_book(file: UploadFile, book_type: str, user: dict) BookPreview
        +get_books(user: dict, book_type: Optional[str]) List~BookSchema~
        +get_book(book_id: str, user: dict) BookWithChapters
        +delete_book(book_id: str, user: dict) Dict
        +save_book_structure(book_id: str, structure: dict, user: dict) Dict
    }

    class AIRouter {
        +generate_script_and_scenes(request: ScriptRequest, user: dict) ScriptResponse
        +generate_entertainment_video(request: VideoRequest, user: dict) VideoResponse
        +get_video_generation_status(video_gen_id: str, user: dict) StatusResponse
        +retry_video_generation(video_gen_id: str, retry_from_step: str, user: dict) Dict
        +get_pipeline_status(video_gen_id: str, user: dict) PipelineStatus
    }

    class PlotsRouter {
        +generate_plot_overview(book_id: str, request: PlotRequest, user: dict) PlotResponse
        +get_plot_overview(book_id: str, user: dict) PlotResponse
        +update_plot_overview(plot_id: str, update: PlotUpdate, user: dict) PlotResponse
        +delete_plot_overview(plot_id: str, user: dict) Dict
    }

    class CharactersRouter {
        +create_character(plot_id: str, character: CharacterCreate, user: dict) CharacterResponse
        +get_character(character_id: str, user: dict) CharacterResponse
        +update_character(character_id: str, update: CharacterUpdate, user: dict) CharacterResponse
        +analyze_character_archetypes(character_id: str, user: dict) ArchetypeAnalysis
        +generate_character_image(character_id: str, prompt: Optional[str], user: dict) ImageResponse
    }

    class SubscriptionsRouter {
        +get_current_subscription(user: dict) UserSubscription
        +create_checkout_session(request: CheckoutRequest, user: dict) CheckoutResponse
        +handle_stripe_webhook(request: Request) Dict
        +get_usage_stats(user: dict) UsageStats
        +cancel_subscription(user: dict) CancelResponse
    }

    class AdminRouter {
        +get_cost_summary(admin: dict) CostSummary
        +get_cost_by_tier(tier: str, admin: dict) CostData
        +get_fallback_rates(admin: dict) FallbackMetrics
        +get_model_performance(admin: dict) PerformanceMetrics
        +list_all_users(admin: dict, limit: int, offset: int) UsersResponse
    }

    FastAPIApp --> AuthRouter : includes
    FastAPIApp --> BooksRouter : includes
    FastAPIApp --> AIRouter : includes
    FastAPIApp --> PlotsRouter : includes
    FastAPIApp --> CharactersRouter : includes
    FastAPIApp --> SubscriptionsRouter : includes
    FastAPIApp --> AdminRouter : includes
</div></code></pre>
<hr>
<h2 id="sequence-diagrams">Sequence Diagrams</h2>
<h3 id="1-user-registration--email-verification-flow">1. User Registration &amp; Email Verification Flow</h3>
<pre><code class="language-mermaid"><div class="mermaid">sequenceDiagram
    actor User
    participant Frontend
    participant API
    participant Supabase
    participant Mailgun
    participant DB

    User->>Frontend: Enter registration details
    Frontend->>API: POST /api/v1/auth/register
    
    API->>Supabase: signUp(email, password)
    Supabase-->>API: user_id, session
    
    API->>DB: Create profile record
    DB-->>API: profile created
    
    API->>DB: Create verification token
    DB-->>API: token created
    
    API->>Mailgun: Send verification email
    Mailgun-->>API: email queued
    
    API-->>Frontend: {user_id, requires_verification: true}
    Frontend-->>User: Check email for verification
    
    Note over User: User clicks email link
    
    User->>Frontend: Click verification link
    Frontend->>API: POST /api/v1/auth/verify-email?token=xxx
    
    API->>DB: Verify token
    DB-->>API: token valid
    
    API->>Supabase: Update email_confirmed_at
    Supabase-->>API: confirmed
    
    API->>DB: Mark token as used
    DB-->>API: updated
    
    API-->>Frontend: {verified: true}
    Frontend-->>User: Email verified! Please login
</div></code></pre>
<h3 id="2-book-upload--processing-flow">2. Book Upload &amp; Processing Flow</h3>
<pre><code class="language-mermaid"><div class="mermaid">sequenceDiagram
    actor User
    participant Frontend
    participant API
    participant FileService
    participant AIService
    participant DB
    participant Storage

    User->>Frontend: Upload book file
    Frontend->>API: POST /api/v1/books/upload (multipart)
    
    API->>FileService: extract_text(file)
    
    alt PDF File
        FileService->>FileService: PyPDF2.extract()
    else DOCX File
        FileService->>FileService: python-docx.extract()
    else EPUB File
        FileService->>FileService: ebooklib.extract()
    end
    
    FileService-->>API: raw_text
    
    API->>Storage: Upload original file
    Storage-->>API: file_url
    
    API->>DB: Create book record (status: processing)
    DB-->>API: book_id
    
    API->>AIService: generate_chapters_from_content(text, book_type)
    
    AIService->>AIService: Chunk text intelligently
    AIService->>OpenAI/DeepSeek: Generate chapter structure
    OpenAI/DeepSeek-->>AIService: chapters JSON
    
    AIService-->>API: chapters_list
    
    loop For each chapter
        API->>DB: Insert chapter
        DB-->>API: chapter_id
        
        API->>AIService: generate_summary(chapter_content)
        AIService-->>API: summary
        
        API->>DB: Update chapter with summary
    end
    
    API->>DB: Update book (status: ready, total_chapters)
    DB-->>API: updated
    
    API-->>Frontend: {book_id, status: 'ready', chapters: [...]}
    Frontend-->>User: Book ready! View chapters
</div></code></pre>
<h3 id="3-script-generation-with-plot-context-flow">3. Script Generation with Plot Context Flow</h3>
<pre><code class="language-mermaid"><div class="mermaid">sequenceDiagram
    actor User
    participant Frontend
    participant API
    participant PlotService
    participant RAGService
    participant OpenRouter
    participant SubscriptionMgr
    participant DB

    User->>Frontend: Generate script
    Frontend->>API: POST /api/v1/ai/generate-script-and-scenes
    
    API->>SubscriptionMgr: get_user_tier(user_id)
    SubscriptionMgr->>DB: Query user_subscriptions
    DB-->>SubscriptionMgr: tier='premium'
    SubscriptionMgr-->>API: ModelTier.PREMIUM
    
    API->>SubscriptionMgr: check_usage_limits(user_id, 'script')
    SubscriptionMgr->>DB: Query usage_logs
    DB-->>SubscriptionMgr: usage_data
    SubscriptionMgr-->>API: {can_generate: true, remaining: 85}
    
    API->>PlotService: get_plot_overview(book_id, user_id)
    PlotService->>DB: Query plot_overviews + characters
    DB-->>PlotService: plot_data
    PlotService-->>API: plot_context
    
    API->>RAGService: get_chapter_with_context(chapter_id)
    RAGService->>DB: Query chapter + embeddings
    DB-->>RAGService: chapter_data
    RAGService->>DB: Vector search for similar content
    DB-->>RAGService: related_chapters
    RAGService-->>API: enhanced_context
    
    API->>OpenRouter: generate_script(content, tier=PREMIUM, plot_context)
    
    OpenRouter->>OpenRouter: Select GPT-4o (premium tier)
    OpenRouter->>OpenAI: API call
    OpenAI-->>OpenRouter: generated_script
    OpenRouter->>OpenRouter: Calculate cost ($0.50)
    OpenRouter-->>API: {script, scenes, cost}
    
    API->>DB: Insert script record
    DB-->>API: script_id
    
    loop For each scene
        API->>DB: Insert scene_description
        DB-->>API: scene_id
    end
    
    API->>SubscriptionMgr: record_usage(user_id, 'script', 0.50)
    SubscriptionMgr->>DB: Insert usage_log
    DB-->>SubscriptionMgr: logged
    
    API-->>Frontend: {script_id, script, scenes, characters}
    Frontend-->>User: Script generated!
</div></code></pre>
<h3 id="4-video-generation-pipeline-flow">4. Video Generation Pipeline Flow</h3>
<pre><code class="language-mermaid"><div class="mermaid">sequenceDiagram
    actor User
    participant Frontend
    participant API
    participant Celery
    participant ImageWorker
    participant AudioWorker
    participant VideoWorker
    participant MergeWorker
    participant DB
    participant ModelsLab
    participant ElevenLabs

    User->>Frontend: Generate video
    Frontend->>API: POST /api/v1/ai/generate-entertainment-video
    
    API->>DB: Create video_generation record
    DB-->>API: video_gen_id
    
    API->>Celery: Queue character image tasks
    API->>Celery: Queue scene image tasks
    API-->>Frontend: {video_gen_id, status: 'pending'}
    
    par Character Images
        Celery->>ImageWorker: generate_character_image_task
        ImageWorker->>ModelsLab: Generate character images
        ModelsLab-->>ImageWorker: image_urls
        ImageWorker->>DB: Store image_generations
    and Scene Images
        Celery->>ImageWorker: generate_scene_image_task
        ImageWorker->>ModelsLab: Generate scene images
        ModelsLab-->>ImageWorker: image_urls
        ImageWorker->>DB: Store image_generations
    end
    
    ImageWorker->>DB: Update video_generation (status: images_complete)
    
    loop For each scene
        Celery->>AudioWorker: generate_audio_task
        AudioWorker->>ElevenLabs: Synthesize dialogue/narration
        ElevenLabs-->>AudioWorker: audio_data
        AudioWorker->>DB: Store audio_generation
        DB-->>AudioWorker: audio_id
    end
    
    AudioWorker->>DB: Update video_generation (status: audio_complete)
    
    loop For each scene
        Celery->>VideoWorker: generate_scene_video_task
        VideoWorker->>ModelsLab: Generate video from image+audio
        ModelsLab-->>VideoWorker: video_url
        VideoWorker->>DB: Store scene_video
        DB-->>VideoWorker: scene_video_id
    end
    
    VideoWorker->>DB: Update video_generation (status: video_complete)
    
    Celery->>MergeWorker: merge_videos_task
    MergeWorker->>MergeWorker: FFmpeg merge all scenes
    MergeWorker->>DB: Upload final video
    DB-->>MergeWorker: final_video_url
    
    MergeWorker->>DB: Update video_generation (status: completed, video_url)
    
    Note over Frontend: Polling for status
    Frontend->>API: GET /api/v1/ai/video-generation-status/{video_gen_id}
    API->>DB: Query video_generation
    DB-->>API: {status: 'completed', video_url, progress: 100}
    API-->>Frontend: Video complete!
    Frontend-->>User: Your video is ready!
</div></code></pre>
<h3 id="5-subscription--payment-flow">5. Subscription &amp; Payment Flow</h3>
<pre><code class="language-mermaid"><div class="mermaid">sequenceDiagram
    actor User
    participant Frontend
    participant API
    participant Stripe
    participant SubscriptionMgr
    participant DB
    participant Webhook

    User->>Frontend: Select Premium tier
    Frontend->>API: POST /api/v1/subscriptions/checkout
    
    API->>SubscriptionMgr: create_checkout_session(user_id, 'premium')
    SubscriptionMgr->>Stripe: Create checkout session
    Stripe-->>SubscriptionMgr: {session_id, checkout_url}
    SubscriptionMgr-->>API: checkout_data
    
    API-->>Frontend: {checkout_url}
    Frontend->>User: Redirect to Stripe
    
    User->>Stripe: Enter payment details
    Stripe-->>User: Payment successful
    
    Stripe->>Webhook: POST /api/v1/subscriptions/webhook
    Note over Webhook: Event: checkout.session.completed
    
    Webhook->>API: Process webhook
    API->>SubscriptionMgr: handle_webhook(event_data)
    
    SubscriptionMgr->>DB: Create/Update user_subscription
    DB-->>SubscriptionMgr: subscription_record
    
    SubscriptionMgr->>DB: Insert subscription_history
    DB-->>SubscriptionMgr: history_record
    
    SubscriptionMgr-->>API: Subscription updated
    API-->>Webhook: 200 OK
    
    Stripe->>User: Redirect to success_url
    User->>Frontend: Return to app
    
    Frontend->>API: GET /api/v1/subscriptions/current
    API->>DB: Query user_subscriptions
    DB-->>API: {tier: 'premium', status: 'active'}
    API-->>Frontend: Subscription data
    
    Frontend-->>User: Premium features unlocked!
</div></code></pre>
<hr>
<h2 id="activity-diagrams">Activity Diagrams</h2>
<h3 id="1-content-generation-decision-flow">1. Content Generation Decision Flow</h3>
<pre><code class="language-mermaid"><div class="mermaid">graph TD
    Start([User Requests Content Generation]) --> CheckAuth{User<br/>Authenticated?}
    CheckAuth -->|No| ReturnAuth[Return 401 Unauthorized]
    CheckAuth -->|Yes| GetTier[Get User Subscription Tier]
    
    GetTier --> CheckLimits{Usage Within<br/>Limits?}
    CheckLimits -->|No| ReturnLimit[Return 402 Limit Exceeded]
    CheckLimits -->|Yes| DetermineModel[Determine AI Model Based on Tier]
    
    DetermineModel --> TierCheck{Tier Level?}
    TierCheck -->|Free| UseFreeModel[Use Llama 3.2 3B]
    TierCheck -->|Basic| UseBasicModel[Use DeepSeek Chat]
    TierCheck -->|Standard| UseStandardModel[Use Claude 3 Haiku]
    TierCheck -->|Premium| UsePremiumModel[Use GPT-4o]
    TierCheck -->|Professional| UseProfessionalModel[Use Claude 3.5 Sonnet]
    
    UseFreeModel --> CallAI[Call AI Service]
    UseBasicModel --> CallAI
    UseStandardModel --> CallAI
    UsePremiumModel --> CallAI
    UseProfessionalModel --> CallAI
    
    CallAI --> AISuccess{AI Call<br/>Successful?}
    AISuccess -->|No| TryFallback[Try Fallback Model]
    TryFallback --> AISuccess
    
    AISuccess -->|Yes| CalculateCost[Calculate Generation Cost]
    CalculateCost --> RecordUsage[Record Usage in Database]
    RecordUsage --> CheckCost{Cost Within<br/>Budget?}
    
    CheckCost -->|No| SendAlert[Send Cost Alert]
    CheckCost -->|Yes| ReturnContent[Return Generated Content]
    SendAlert --> ReturnContent
    
    ReturnContent --> End([End])
    ReturnAuth --> End
    ReturnLimit --> End
</div></code></pre>
<h3 id="2-video-pipeline-processing-activity">2. Video Pipeline Processing Activity</h3>
<pre><code class="language-mermaid"><div class="mermaid">graph TD
    Start([Video Generation Request]) --> CreateRecord[Create video_generation Record]
    CreateRecord --> QueueScript[Queue Script Generation Task]
    
    QueueScript --> GenerateScript[Generate Script with OpenRouter]
    GenerateScript --> ScriptSuccess{Script<br/>Generated?}
    ScriptSuccess -->|No| MarkFailed[Mark as Failed]
    ScriptSuccess -->|Yes| ParseScenes[Parse Scenes & Characters]
    
    ParseScenes --> QueueImages[Queue Image Generation Tasks]
    QueueImages --> ParallelImages{Generate Images<br/>in Parallel}
    
    ParallelImages --> CharImages[Generate Character Images]
    ParallelImages --> SceneImages[Generate Scene Images]
    
    CharImages --> CheckCharImages{All Character<br/>Images Ready?}
    SceneImages --> CheckSceneImages{All Scene<br/>Images Ready?}
    
    CheckCharImages -->|No| RetryCharImage[Retry Failed Images]
    CheckSceneImages -->|No| RetrySceneImage[Retry Failed Images]
    RetryCharImage --> CheckCharImages
    RetrySceneImage --> CheckSceneImages
    
    CheckCharImages -->|Yes| ImagesComplete{All Images<br/>Complete?}
    CheckSceneImages -->|Yes| ImagesComplete
    
    ImagesComplete -->|No| MarkFailed
    ImagesComplete -->|Yes| QueueAudio[Queue Audio Generation]
    
    QueueAudio --> GenerateAudio[Generate Audio for Each Scene]
    GenerateAudio --> AudioSuccess{All Audio<br/>Generated?}
    AudioSuccess -->|No| RetryAudio[Retry Failed Audio]
    RetryAudio --> AudioSuccess
    AudioSuccess -->|Yes| QueueVideo[Queue Video Generation]
    
    QueueVideo --> GenerateVideos[Generate Scene Videos]
    GenerateVideos --> VideoSuccess{All Videos<br/>Generated?}
    VideoSuccess -->|No| RetryVideo[Retry Failed Videos]
    RetryVideo --> VideoSuccess
    VideoSuccess -->|Yes| QueueLipSync[Queue Lip Sync Tasks]
    
    QueueLipSync --> ProcessLipSync[Process Lip Sync]
    ProcessLipSync --> LipSyncSuccess{Lip Sync<br/>Complete?}
    LipSyncSuccess -->|No| SkipLipSync[Skip Lip Sync]
    LipSyncSuccess -->|Yes| QueueMerge[Queue Merge Task]
    SkipLipSync --> QueueMerge
    
    QueueMerge --> MergeVideos[Merge All Scene Videos with FFmpeg]
    MergeVideos --> MergeSuccess{Merge<br/>Successful?}
    MergeSuccess -->|No| RetryMerge[Retry Merge]
    RetryMerge --> MergeSuccess
    MergeSuccess -->|Yes| UploadFinal[Upload Final Video]
    
    UploadFinal --> MarkComplete[Mark as Completed]
    MarkComplete --> NotifyUser[Notify User]
    NotifyUser --> End([End])
    MarkFailed --> End
</div></code></pre>
<h3 id="3-cost-tracking--alert-activity">3. Cost Tracking &amp; Alert Activity</h3>
<pre><code class="language-mermaid"><div class="mermaid">graph TD
    Start([API Call Made]) --> RecordCall[Record API Usage]
    RecordCall --> CalculateCost[Calculate Cost Based on Tokens/Duration]
    
    CalculateCost --> StoreUsage[Store in usage_logs Table]
    StoreUsage --> UpdateCache[Update Redis Cost Counter]
    
    UpdateCache --> GetThreshold[Get Cost Threshold for User Tier]
    GetThreshold --> CheckThreshold{Cost Exceeds<br/>Threshold?}
    
    CheckThreshold -->|No| UpdateMetrics[Update Model Metrics]
    CheckThreshold -->|Yes| DetermineLevel{Threshold Level?}
    
    DetermineLevel -->|75%| SendWarning[Send Warning Email]
    DetermineLevel -->|90%| SendUrgent[Send Urgent Alert]
    DetermineLevel -->|100%| ApplyThrottle[Apply Rate Throttling]
    
    SendWarning --> UpdateMetrics
    SendUrgent --> UpdateMetrics
    ApplyThrottle --> SwitchModel[Switch to Cheaper Model]
    SwitchModel --> UpdateMetrics
    
    UpdateMetrics --> AggregateDaily{End of Day?}
    AggregateDaily -->|Yes| CreateAggregation[Create cost_aggregation Record]
    AggregateDaily -->|No| End([End])
    
    CreateAggregation --> GenerateReport[Generate Cost Report]
    GenerateReport --> End
</div></code></pre>
<hr>
<h2 id="state-machine-diagrams">State Machine Diagrams</h2>
<h3 id="1-video-generation-state-machine">1. Video Generation State Machine</h3>
<pre><code class="language-mermaid"><div class="mermaid">stateDiagram-v2
    [*] --> pending: Request Created
    
    pending --> script_generation: Worker Picks Up Task
    script_generation --> image_generation: Script Complete
    script_generation --> failed: Script Generation Failed
    
    image_generation --> audio_generation: All Images Generated
    image_generation --> failed: Image Generation Failed (After Retries)
    
    audio_generation --> video_generation: All Audio Generated
    audio_generation --> failed: Audio Generation Failed
    
    video_generation --> lipsync: All Videos Generated
    video_generation --> merge: Lip Sync Skipped
    video_generation --> failed: Video Generation Failed
    
    lipsync --> merge: Lip Sync Complete
    lipsync --> merge: Lip Sync Failed (Continue Without)
    
    merge --> completed: Merge Successful
    merge --> failed: Merge Failed (After Retries)
    
    failed --> pending: Retry Requested
    completed --> [*]
    failed --> [*]
    
    note right of script_generation
        Tier-based model selection
        OpenRouter routing
    end note
    
    note right of image_generation
        Parallel processing
        ModelsLab API
    end note
    
    note right of video_generation
        Scene-by-scene generation
        Progress tracking
    end note
</div></code></pre>
<h3 id="2-subscription-status-state-machine">2. Subscription Status State Machine</h3>
<pre><code class="language-mermaid"><div class="mermaid">stateDiagram-v2
    [*] --> trialing: New User / Trial Started
    
    trialing --> active: Trial Converted
    trialing --> canceled: Trial Canceled
    
    active --> past_due: Payment Failed
    active --> canceled: User Canceled
    
    past_due --> active: Payment Retry Successful
    past_due --> canceled: Grace Period Expired
    
    canceled --> active: Reactivated
    canceled --> [*]: Subscription Ended
    
    active --> active: Renewal Successful
    
    note right of trialing
        7-14 day trial period
        Full access
    end note
    
    note right of past_due
        3 retry attempts
        Grace period: 7 days
    end note
    
    note right of active
        Monthly billing cycle
        Usage tracked
    end note
</div></code></pre>
<h3 id="3-user-role-progression-state-machine">3. User Role Progression State Machine</h3>
<pre><code class="language-mermaid"><div class="mermaid">stateDiagram-v2
    [*] --> user: Registration Complete
    
    user --> creator: Upgrade to Creator
    user --> author: Become Author
    
    creator --> professional_creator: Premium Subscription
    author --> verified_author: Author Verification
    
    professional_creator --> superadmin: Admin Promotion
    verified_author --> superadmin: Admin Promotion
    
    superadmin --> [*]: Role Revoked (Rare)
    
    note right of user
        Basic access
        Learning mode
    end note
    
    note right of creator
        Plot management
        Advanced tools
    end note
    
    note right of professional_creator
        API access
        Unlimited generations
    end note
    
    note right of superadmin
        Full platform access
        User management
    end note
</div></code></pre>
<hr>
<h2 id="interaction-overview-diagrams">Interaction Overview Diagrams</h2>
<h3 id="component-interaction-matrix">Component Interaction Matrix</h3>
<table>
<thead>
<tr>
<th>Component</th>
<th>Interacts With</th>
<th>Communication Method</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Frontend</strong></td>
<td>API Gateway</td>
<td>HTTPS REST</td>
<td>All user operations</td>
</tr>
<tr>
<td><strong>API Gateway</strong></td>
<td>Supabase Auth</td>
<td>JWT Verification</td>
<td>Authentication</td>
</tr>
<tr>
<td><strong>API Gateway</strong></td>
<td>PostgreSQL</td>
<td>asyncpg</td>
<td>Data operations</td>
</tr>
<tr>
<td><strong>API Gateway</strong></td>
<td>Redis</td>
<td>redis-py</td>
<td>Caching, session</td>
</tr>
<tr>
<td><strong>API Gateway</strong></td>
<td>Celery Queue</td>
<td>Redis</td>
<td>Task queueing</td>
</tr>
<tr>
<td><strong>Celery Workers</strong></td>
<td>Redis Queue</td>
<td>Redis protocol</td>
<td>Task polling</td>
</tr>
<tr>
<td><strong>Celery Workers</strong></td>
<td>PostgreSQL</td>
<td>psycopg2</td>
<td>Status updates</td>
</tr>
<tr>
<td><strong>Celery Workers</strong></td>
<td>ModelsLab API</td>
<td>HTTPS</td>
<td>Image/Video gen</td>
</tr>
<tr>
<td><strong>Celery Workers</strong></td>
<td>ElevenLabs API</td>
<td>HTTPS</td>
<td>Audio synthesis</td>
</tr>
<tr>
<td><strong>OpenRouter Service</strong></td>
<td>OpenRouter API</td>
<td>HTTPS</td>
<td>LLM routing</td>
</tr>
<tr>
<td><strong>Subscription Manager</strong></td>
<td>Stripe API</td>
<td>HTTPS</td>
<td>Payments</td>
</tr>
<tr>
<td><strong>Email Service</strong></td>
<td>Mailgun API</td>
<td>HTTPS</td>
<td>Email sending</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="references">References</h2>
<ul>
<li><a href="https://www.omg.org/spec/UML/">UML 2.5 Specification</a></li>
<li><a href="https://mermaid.js.org/">Mermaid Diagram Syntax</a></li>
<li><a href="README.md">Main Architecture README</a></li>
<li><a href="C4-DIAGRAMS.md">C4 Model Diagrams</a></li>
</ul>
<hr>
<p><strong>Last Updated</strong>: 2025-11-06<br>
<strong>Version</strong>: 1.0<br>
<strong>Maintained By</strong>: Architecture Team</p>

</body>
</html>
